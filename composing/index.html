<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Composing Multi-Step Models · NeXLUncertainties.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
<script src="https://pages.nist.gov/nist-header-footer/js/jquery-1.9.0.min.js" type="text/javascript" defer="defer"></script>
<script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>
</head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="NeXLUncertainties.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">NeXLUncertainties.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../gettingstarted/">Getting Started</a></li><li class="is-active"><a class="tocitem" href>Composing Multi-Step Models</a><ul class="internal"><li><a class="tocitem" href="#Composing-and-Parallelizing"><span>Composing and Parallelizing</span></a></li></ul></li><li><a class="tocitem" href="../resistors/">Resistor Network Example</a></li><li><a class="tocitem" href="../methods/">Methods</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Composing Multi-Step Models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Composing Multi-Step Models</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/usnistgov/NeXLUncertainties.jl/blob/master/docs/src/composing.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h2 id="Composing-and-Parallelizing"><a class="docs-heading-anchor" href="#Composing-and-Parallelizing">Composing and Parallelizing</a><a id="Composing-and-Parallelizing-1"></a><a class="docs-heading-anchor-permalink" href="#Composing-and-Parallelizing" title="Permalink"></a></h2><h4 id="Sequential-Steps"><a class="docs-heading-anchor" href="#Sequential-Steps">Sequential Steps</a><a id="Sequential-Steps-1"></a><a class="docs-heading-anchor-permalink" href="#Sequential-Steps" title="Permalink"></a></h4><p>When one sits down to perform uncertainty propagation, it can be overwhelming. The measurement models can be complex.  The thought of computing the necessary partial derivatives can be intimidating.  However, many models can be factored into a series of simple steps - compute this and then compute that from this. Taken one-by-one, it is likely to be a lot easier to compute the partial derivatives for the simple steps than for the full model.</p><p>Fortunately, we have the chain-rule of differential calculus.  The chain rule says that</p><p class="math-container">\[\frac{δf(g(x))}{δx} = \left. \frac{δf(y)}{δy}\right |_{y=g(x)} \frac{δg(x)}{δx}\]</p><p>The key fact here is that we can break a complex problem into a series of simpler steps.  We don&#39;t need to compute <span>$\frac{δf(g(x))}{δx}$</span> directly.  We can compute <span>$\frac{δf(y)}{δy}$</span> and <span>$\frac{δg(x)}{δx}$</span> and use the chain rule to compute <span>$\frac{δf(g(x))}{δx}$</span>.</p><p>In the multivariate world, it gets even better. If <span>$F(X)$</span> and <span>$G(Y)$</span> are a vector functions of a vector variable and <span>$J[F(X)]$</span> and <span>$J[G(Y)]$</span> are the Jacobians of <span>$F(X)$</span> and <span>$G(Y)$</span> respectively then</p><p class="math-container">\[J[G(F(X))] = \left. J[G(Y)] \right |_{Y=G(X)} J[F(X)]\]</p><p>That is to say, if we compute the Jacobian matrix for each step, we can compute the Jacobian for the entire calculation by taking the product of the Jacobians. All the bookkeeping necessary handle all the variables is performed by matrix products.  This is far simpler than the univariate measurement model case outlined in the <a href="https://www.bipm.org/en/publications/guides/gum.html">BIPM GUM</a>. For comparison, consider equation 13 on page 21 of the GUM.  Equation 13 is exactly equivalent to the Jacobian expression in the univariate case but the bookkeeping is so much less clear.</p><p>The equivalent of equation 13 in the multivariate case is</p><p class="math-container">\[U(F(X)) = J[F(X)] U(X) J[F(X)]^T\]</p><p>Clean, simple, straighforward.</p><p>From a practical perspective, this library allows you to implementing <code>MeasurementModel</code> types to represent each step in a calculation.  So let&#39;s say we implement measurement models <code>MM1</code>, <code>MM2</code> and <code>MM3</code>.  The output of <code>MM1</code> is a superset of the values required as input to <code>MM2</code> and the output of <code>MM2</code> is a superset of the values required as input to <code>MM3</code>. We can create an object to represent the composition of these models using the &quot;compose operator&quot; ∘ - <code>MM1to3 = MM3 ∘ MM2 ∘ MM1</code>. <code>MM1to3(X)</code> is conceptually equivalent to <code>MM3(MM2(MM1(X)))</code>. (The ∘ operator is syntactic sugar for the <code>ComposedMeasurementModel</code> type.)</p><p>Like we did on the <a href="../gettingstarted/index.html">Getting Started</a> page, it is possible to apply the composed <code>MeasurementModel</code> <code>MM1to3</code> to either input represented by an <code>UncertainValues</code> object (the full uncertainty calculation) or a <code>LabeledValues</code> object (just the function evaluation). The computational cost of the entire calculation is roughly the sum of the cost of the individual steps plus the matrix products of the Jacobians.</p><p>One subtlety - sometimes it is necessary to pass variables unmodified from one step to the next.  This is of course handled trivially by the identity function with derivative of unity.  Since this is common, there is a special mechanism to handle this using the <code>MaintainInputs</code> or <code>AllInputs</code> <code>MeasurementModel</code>s combined with the next concept - parallel steps.</p><p>See the &quot;Resistor Network Example&quot; for a (somewhat) simple multi-step computation.</p><h4 id="Parallel-Steps"><a class="docs-heading-anchor" href="#Parallel-Steps">Parallel Steps</a><a id="Parallel-Steps-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-Steps" title="Permalink"></a></h4><p>In some measurement models, the same calculation is repeated on multiple sets of input data.  In this case, it is useful to be able to apply the same <code>MeasurementModel</code> to different sub-sets of the data.  For example, if you want to compute the X-ray mass absorption coefficient (MAC) for a series of different X-rays lines, you might define a generic <code>MeasurementModel</code> <code>ComputeMAC</code> that computes the MAC for a single X-ray line.  You could apply the model sequentially as described in &quot;sequential steps&quot;.  However, it would often be more efficient to compute the MACs in parallel as a single step.</p><p>There are two operators to handle steps that can be calculated in parallel and combined to look like a single step = &quot;^&quot; and &quot;|&quot;.  The first of these, &quot;^&quot;, uses <code>@threads</code> to parallelize the calculation. The second performs the calculation sequentially.  If the calculation is simple and quick use &quot;|&quot;.  If the calculation is longer and more complex, &quot;^&quot; <em>may</em> be faster depending upon the relative cost of the calculation and the cost of spinning up multiple threads.  &quot;|&quot; and &quot;^&quot; are syntactic sugar for the &quot;ParallelMeasurementModel&quot; type.</p><p>There is a second use for the &quot;|&quot; and &quot;^&quot; operators (or the <code>ParallelMeasurementModel</code> type) is to pass variables unmodified from one step to the next using the <code>MaintainInputs</code> and <code>AllInputs</code> <code>MeasurementModel</code> types.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../gettingstarted/">« Getting Started</a><a class="docs-footer-nextpage" href="../resistors/">Resistor Network Example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Thursday 30 December 2021 12:15">Thursday 30 December 2021</span>. Using Julia version 1.7.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
